<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Peminjaman Buku - Digital Library</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-left">
                <h1><i class="fas fa-hand-holding-heart"></i> Peminjaman Buku</h1>
            </div>
            <div class="header-right">
                <div class="user-info">
                    <div class="user-avatar">U</div>
                    <span id="userName">User</span>
                </div>
                <button onclick="window.location.href='dashboard.html'" class="btn-action">
                    <i class="fas fa-arrow-left"></i> Kembali
                </button>
            </div>
        </header>

        <div class="dashboard-content" style="display: flex;">
            <!-- Sidebar -->
            <nav class="dashboard-sidebar">
                <a href="dashboard.html" class="nav-item">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a href="books.html" class="nav-item active">
                    <i class="fas fa-hand-holding-heart"></i> Peminjaman
                </a>
                <a href="artikel.html" class="nav-item">
                    <i class="fas fa-newspaper"></i> Artikel
                </a>
                <a href="borrow.html" class="nav-item">
                    <i class="fas fa-undo"></i> Pengembalian
                </a>
                <div class="sidebar-divider"></div>
                <a href="admin.html" class="nav-item" id="adminMenu">
                    <i class="fas fa-user-cog"></i> Admin
                </a>
                <div class="sidebar-divider"></div>
                <a href="index.html" class="nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </nav>

            <!-- Main Content -->
            <main class="dashboard-main">
                <!-- Book Selection -->
                <div class="book-selection-container">
                    <h2 class="section-title"><i class="fas fa-search"></i> Pilih Buku untuk Dipinjam</h2>
                    <div class="book-grid" id="bookGrid">
                        <!-- Book cards akan diisi oleh JavaScript -->
                    </div>
                </div>

                <!-- Borrow History -->
                <div class="borrow-history-container" style="margin-top: 50px;">
                    <h2 class="section-title"><i class="fas fa-history"></i> Riwayat Peminjaman Saya</h2>
                    <div class="borrow-cards-container" id="borrowCardsContainer">
                        <!-- Borrow records akan diisi oleh JavaScript -->
                    </div>
                </div>

                <!-- Add Book Button (Admin) -->
                <div style="text-align: center; margin-top: 30px; display: none;" id="addBookButtonContainer">
                    <button onclick="openModal('addBookModal')" class="btn-action btn-return" style="font-size: 16px; padding: 12px 30px;">
                        <i class="fas fa-plus-circle"></i> Tambah Buku Baru
                    </button>
                </div>
            </main>
        </div>
    </div>

    <!-- Borrow Modal -->
    <div id="borrowModal" class="modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Pinjam Buku</h2>
                <button class="close-modal" onclick="closeModal('borrowModal')">&times;</button>
            </div>
            <form id="borrowForm" onsubmit="submitBorrow(event)">
                <div id="bookDetailModal" style="margin-bottom: 20px; padding: 15px; background: var(--ipm-light-green); border-radius: 8px;">
                    <p style="font-weight: 600; color: var(--ipm-green); margin: 0;"><span id="modalBookTitle">Judul Buku</span></p>
                    <small style="color: #666;"><span id="modalBookAuthor">Penulis</span></small>
                </div>
                <div class="form-group">
                    <label for="borrowDate"><i class="fas fa-calendar"></i> Tanggal Pinjam</label>
                    <input type="date" id="borrowDate" required>
                </div>
                <div class="form-group">
                    <label for="borrowDuration"><i class="fas fa-clock"></i> Durasi Peminjaman</label>
                    <select id="borrowDuration" required>
                        <option value="">-- Pilih Durasi --</option>
                        <option value="7">7 Hari</option>
                        <option value="14">14 Hari</option>
                        <option value="21">21 Hari</option>
                        <option value="30">30 Hari</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="borrowNotes"><i class="fas fa-sticky-note"></i> Catatan (Opsional)</label>
                    <textarea id="borrowNotes" placeholder="Tambahkan catatan jika perlu..." rows="3" style="border: 1px solid #ddd; padding: 10px; border-radius: 4px; font-family: inherit;"></textarea>
                </div>
                <button type="submit" class="btn-action btn-borrow" style="width: 100%;">
                    <i class="fas fa-check"></i> Pinjam Buku
                </button>
            </form>
        </div>
    </div>

    <!-- Add Book Modal -->
    <div id="addBookModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Tambah Buku Baru</h2>
                <button class="close-modal" onclick="closeModal('addBookModal')">&times;</button>
            </div>
            <form id="addBookForm">
                <div class="form-group">
                    <label>Judul Buku</label>
                    <input type="text" id="bookTitle" required>
                </div>
                <div class="form-group">
                    <label>Penulis</label>
                    <input type="text" id="bookAuthor" required>
                </div>
                <div class="form-group">
                    <label>Kategori</label>
                    <select id="bookCategory" required>
                        <option value="">Pilih Kategori</option>
                        <option value="Programming">Programming</option>
                        <option value="Data Science">Data Science</option>
                        <option value="Web Development">Web Development</option>
                        <option value="AI">AI</option>
                        <option value="Database">Database</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Tahun Terbit</label>
                    <input type="number" id="bookYear" min="1900" max="2024" required>
                </div>
                <div class="form-group">
                    <label>ISBN</label>
                    <input type="text" id="bookISBN">
                </div>
                <button type="button" onclick="addBook()" class="btn-action btn-return" style="width: 100%;">
                    <i class="fas fa-save"></i> Simpan Buku
                </button>
            </form>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        let selectedBookId = null;

        document.addEventListener('DOMContentLoaded', function() {
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            if (currentUser) {
                document.getElementById('userName').textContent = currentUser.username;
                
                // Show add book button untuk admin
                const addBookContainer = document.getElementById('addBookButtonContainer');
                if (addBookContainer && currentUser.role === 'admin') {
                    addBookContainer.style.display = 'block';
                }
                
                // Hide admin menu untuk user biasa
                const adminMenu = document.getElementById('adminMenu');
                if (adminMenu && currentUser.role !== 'admin') {
                    adminMenu.style.display = 'none';
                    const prevDivider = adminMenu.previousElementSibling;
                    if (prevDivider && prevDivider.classList.contains('sidebar-divider')) {
                        prevDivider.style.display = 'none';
                    }
                }
            }
            
            // Load books grid
            loadBooksGrid();
            
            // Load borrow history
            loadBorrowCardsHistory();
            
            // Set default date to today
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('borrowDate').value = today;
            
            // Wire up form submission
            const addBookForm = document.getElementById('addBookForm');
            if (addBookForm) {
                addBookForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    addBook();
                });
            }
        });

        function loadBooksGrid() {
            const books = getBooks();  // Ambil dari localStorage via script.js
            const bookGrid = document.getElementById('bookGrid');
            
            if (!books || books.length === 0) {
                bookGrid.innerHTML = '<p style="text-align: center; padding: 30px; color: #999;">Belum ada buku tersedia</p>';
                return;
            }
            
            bookGrid.innerHTML = books.map(book => {
                // Generate emoji cover berdasarkan kategori
                const categoryEmojis = {
                    'Programming': 'ðŸ“•',
                    'Teknologi': 'ðŸ“•',
                    'Data Science': 'ðŸ“—',
                    'AI': 'ðŸ“˜',
                    'Web': 'ðŸ“™',
                    'Web Development': 'ðŸ“™',
                    'Database': 'ðŸ“•',
                    'Cloud': 'ðŸ“—',
                    'Machine Learning': 'ðŸ“˜'
                };
                
                const cover = categoryEmojis[book.category] || 'ðŸ“š';
                
                return `
                    <div class="book-card" onclick="selectBookForBorrow(${book.id})">
                        <div class="book-cover">${cover}</div>
                        <div class="book-info">
                            <h3 style="margin: 0 0 8px 0;">${book.title}</h3>
                            <p class="book-author">${book.author}</p>
                            <span class="book-category">${book.category}</span>
                            <button type="button" class="btn-action btn-borrow btn-small" style="cursor: pointer; width: 100%;" onclick="event.stopPropagation(); selectBookForBorrow(${book.id})">
                                <i class="fas fa-hand-holding-heart"></i> Pinjam
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function selectBookForBorrow(bookId) {
            selectedBookId = bookId;
            const books = getBooks();
            const book = books.find(b => b.id === bookId);
            
            if (!book) {
                alert('Buku tidak ditemukan');
                return;
            }
            
            document.getElementById('modalBookTitle').textContent = book.title;
            document.getElementById('modalBookAuthor').textContent = book.author;
            document.getElementById('borrowDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('borrowDuration').value = '';
            document.getElementById('borrowNotes').value = '';
            
            openModal('borrowModal');
        }

        function submitBorrow(event) {
            event.preventDefault();
            
            const borrowDate = document.getElementById('borrowDate').value;
            const borrowDuration = document.getElementById('borrowDuration').value;
            const borrowNotes = document.getElementById('borrowNotes').value;
            
            if (!borrowDate) {
                alert('Pilih tanggal pinjam terlebih dahulu!');
                return;
            }

            if (!borrowDuration) {
                alert('Pilih durasi peminjaman!');
                return;
            }

            const books = getBooks();
            const book = books.find(b => b.id === selectedBookId);
            
            if (!book) {
                alert('Buku tidak ditemukan');
                return;
            }
            
            // Calculate due date
            const bDate = new Date(borrowDate);
            const dueDate = new Date(bDate);
            dueDate.setDate(dueDate.getDate() + parseInt(borrowDuration));
            const dueDateString = dueDate.toISOString().split('T')[0];
            
            // Get existing borrows
            let borrows = JSON.parse(localStorage.getItem('userBorrows')) || [];
            
            // Get current user
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            
            // Create new borrow record
            const newBorrow = {
                id: Math.max(...borrows.map(b => b.id || 0), 0) + 1,
                username: currentUser.username,
                bookId: selectedBookId,
                book: book.title,
                author: book.author,
                borrowDate: borrowDate,
                dueDate: dueDateString,
                status: 'Aktif',
                notes: borrowNotes
            };

            borrows.push(newBorrow);
            localStorage.setItem('userBorrows', JSON.stringify(borrows));

            alert(`âœ“ Buku "${book.title}" berhasil dipinjam!\nBatas kembali: ${dueDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric' })}`);
            
            closeModal('borrowModal');
            loadBorrowCardsHistory();
        }

        function loadBorrowCardsHistory() {
            const container = document.getElementById('borrowCardsContainer');
            const currentUser = JSON.parse(localStorage.getItem('currentUser'));
            let borrows = JSON.parse(localStorage.getItem('userBorrows')) || [];

            // Filter: hanya pinjaman user saat ini dan status Aktif
            const activeBorrows = borrows.filter(b => b.username === currentUser.username && b.status === 'Aktif');

            if (activeBorrows.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #999; padding: 30px;">Anda belum meminjam buku</p>';
                return;
            }

            container.innerHTML = activeBorrows.reverse().map(borrow => {
                const borrowDate = new Date(borrow.borrowDate);
                const dueDate = new Date(borrow.dueDate);
                const today = new Date();
                const isOverdue = today > dueDate;

                const borrowDateString = borrowDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                const dueDateString = dueDate.toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });

                return `
                    <div class="borrow-card" style="${isOverdue ? 'border-left: 5px solid #ff6b6b;' : ''}">
                        <div class="borrow-card-header">
                            <h3>${borrow.book}</h3>
                            <span class="badge" style="background: ${isOverdue ? '#ffebee' : 'var(--ipm-light-yellow)'}; color: ${isOverdue ? '#d32f2f' : 'var(--ipm-green)'};">
                                ${isOverdue ? 'âš  Terlambat' : 'âœ“ Aktif'}
                            </span>
                        </div>
                        <div class="borrow-card-body">
                            <p><i class="fas fa-user-pen"></i> <strong>Penulis:</strong> ${borrow.author}</p>
                            <p><i class="fas fa-calendar-check"></i> <strong>Dipinjam:</strong> ${borrowDateString}</p>
                            <p><i class="fas fa-calendar-times" style="color: ${isOverdue ? '#d32f2f' : '#333'};"></i> <strong>Batas Kembali:</strong> <span style="color: ${isOverdue ? '#d32f2f' : '#333'}; font-weight: 600;">${dueDateString}</span></p>
                            ${borrow.notes ? `<p><i class="fas fa-sticky-note"></i> <strong>Catatan:</strong> ${borrow.notes}</p>` : ''}
                        </div>
                        <div class="borrow-card-actions">
                            <button type="button" class="btn-action btn-small btn-return" onclick="deleteBorrow(${borrow.id})">
                                <i class="fas fa-trash"></i> Hapus
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function deleteBorrow(borrowId) {
            if (confirm('Hapus riwayat peminjaman ini?')) {
                let borrows = JSON.parse(localStorage.getItem('userBorrows')) || [];
                borrows = borrows.filter(b => b.id !== borrowId);
                localStorage.setItem('userBorrows', JSON.stringify(borrows));
                alert('âœ“ Riwayat peminjaman dihapus');
                loadBorrowCardsHistory();
            }
        }
    </script>
</body>
</html>